# x402 Architecture Overview

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         User's Browser                          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Homepage  â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Authenticate â”‚â”€â”€â”€â”€â”€â–¶â”‚ Video Contentâ”‚ â”‚
â”‚  â”‚ page.tsx   â”‚        â”‚   page.tsx   â”‚      â”‚  page.tsx    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                               â”‚                                 â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                        â”‚ X402PaymentClientâ”‚                     â”‚
â”‚                        â”‚  (Component)     â”‚                     â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                               â”‚                                 â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                        â”‚   MetaMask       â”‚                     â”‚
â”‚                        â”‚   (Wallet)       â”‚                     â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ HTTP Requests
                                â”‚ X-PAYMENT Header
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Next.js Server                            â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     API Routes                            â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ authenticate â”‚  â”‚ payment-info â”‚  â”‚video-content â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  /route.ts   â”‚  â”‚  /route.ts   â”‚  â”‚  /route.ts   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚         â”‚                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚     â”‚ x402Middlewareâ”‚                                           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚            â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚              x402 Library                           â”‚        â”‚
â”‚  â”‚                                                      â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚        â”‚
â”‚  â”‚  â”‚constants â”‚  â”‚  utils   â”‚  â”‚  verify  â”‚         â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ Verify Payment
                                         â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      x402 Facilitator            â”‚
                        â”‚   (https://x402.org/facilitator) â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ Settle Payment
                                         â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      Base Blockchain             â”‚
                        â”‚   (Sepolia Testnet/Mainnet)      â”‚
                        â”‚                                   â”‚
                        â”‚   USDC Smart Contract            â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Payment Flow Sequence

```
User          Browser         Next.js Server     Facilitator     Blockchain
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚â”€â”€Click Payâ”€â”€â”€â–¶â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚â”€â”€GET /authenticateâ”‚                â”‚              â”‚
 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚â—€â”€â”€â”€â”€â”€402â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚              â”‚
 â”‚               â”‚  Payment Required â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚â”€â”€Fetch Infoâ”€â”€â”€â”€â”€â”€â”€â”‚                â”‚              â”‚
 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚â—€â”€â”€â”€â”€â”€Configâ”€â”€â”€â”€â”€â”€â”€â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚â—€â”€â”€Connect?â”€â”€â”€â”€â”‚                   â”‚                â”‚              â”‚
 â”‚   (MetaMask)  â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚â”€â”€Approveâ”€â”€â”€â”€â”€â–¶â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚â—€â”€â”€Sign Msgâ”€â”€â”€â”‚                   â”‚                â”‚              â”‚
 â”‚   (EIP-712)   â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚â”€â”€Signatureâ”€â”€â”€â–¶â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚â”€â”€POST /authenticate               â”‚              â”‚
 â”‚               â”‚  X-PAYMENT: {sig} â”‚                â”‚              â”‚
 â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚â”€â”€Verifyâ”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚â”€â”€Settleâ”€â”€â”€â”€â”€â–¶â”‚
 â”‚               â”‚                   â”‚                â”‚  (Transfer)  â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚â—€â”€Confirmedâ”€â”€â”€â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚â—€â”€â”€â”€Validâ”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚               â”‚â—€â”€â”€â”€â”€â”€Redirectâ”€â”€â”€â”€â”€â”‚                â”‚              â”‚
 â”‚               â”‚  /video-content   â”‚                â”‚              â”‚
 â”‚               â”‚                   â”‚                â”‚              â”‚
 â”‚â—€â”€â”€Contentâ”€â”€â”€â”€â”€â”‚                   â”‚                â”‚              â”‚
 â”‚   (Video)     â”‚                   â”‚                â”‚              â”‚
```

## ğŸ“¦ Component Breakdown

### Frontend Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Frontend Components               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  Homepage (page.tsx)                         â”‚
â”‚  â”œâ”€â”€ Hero section                           â”‚
â”‚  â”œâ”€â”€ Feature explanation                    â”‚
â”‚  â””â”€â”€ CTA Button â†’ /authenticate             â”‚
â”‚                                              â”‚
â”‚  Authenticate Page (authenticate/page.tsx)  â”‚
â”‚  â”œâ”€â”€ Payment status UI                      â”‚
â”‚  â”œâ”€â”€ Loading indicators                     â”‚
â”‚  â””â”€â”€ X402PaymentClient Component            â”‚
â”‚      â”œâ”€â”€ Wallet detection                   â”‚
â”‚      â”œâ”€â”€ Network switching                  â”‚
â”‚      â”œâ”€â”€ EIP-712 signing                    â”‚
â”‚      â””â”€â”€ Payment submission                 â”‚
â”‚                                              â”‚
â”‚  Video Content (video-content/page.tsx)     â”‚
â”‚  â”œâ”€â”€ Success message                        â”‚
â”‚  â”œâ”€â”€ Protected content                      â”‚
â”‚  â””â”€â”€ Video embed                            â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Backend Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API Routes                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  /api/authenticate                           â”‚
â”‚  â”œâ”€â”€ x402Middleware                         â”‚
â”‚  â”œâ”€â”€ Check X-PAYMENT header                 â”‚
â”‚  â”œâ”€â”€ Verify with facilitator                â”‚
â”‚  â””â”€â”€ Grant/Deny access                      â”‚
â”‚                                              â”‚
â”‚  /api/payment-info                           â”‚
â”‚  â”œâ”€â”€ Return wallet address                  â”‚
â”‚  â”œâ”€â”€ Return network config                  â”‚
â”‚  â””â”€â”€ Return payment amount                  â”‚
â”‚                                              â”‚
â”‚  /api/video-content                          â”‚
â”‚  â””â”€â”€ Return protected content               â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Library Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            x402 Library                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  constants.ts                                â”‚
â”‚  â”œâ”€â”€ Network configurations                 â”‚
â”‚  â”œâ”€â”€ USDC addresses                         â”‚
â”‚  â””â”€â”€ Protocol constants                     â”‚
â”‚                                              â”‚
â”‚  types.ts                                    â”‚
â”‚  â”œâ”€â”€ PaymentDetails                         â”‚
â”‚  â”œâ”€â”€ PaymentPayload                         â”‚
â”‚  â””â”€â”€ X402Config                             â”‚
â”‚                                              â”‚
â”‚  utils.ts                                    â”‚
â”‚  â”œâ”€â”€ create402Response()                    â”‚
â”‚  â”œâ”€â”€ extractPaymentPayload()                â”‚
â”‚  â”œâ”€â”€ priceToWei()                           â”‚
â”‚  â””â”€â”€ generateNonce()                        â”‚
â”‚                                              â”‚
â”‚  verify.ts                                   â”‚
â”‚  â”œâ”€â”€ verifyPaymentWithFacilitator()         â”‚
â”‚  â”œâ”€â”€ validatePaymentPayload()               â”‚
â”‚  â”œâ”€â”€ isPaymentAmountSufficient()            â”‚
â”‚  â””â”€â”€ isPaymentTimeValid()                   â”‚
â”‚                                              â”‚
â”‚  middleware.ts                               â”‚
â”‚  â””â”€â”€ x402Middleware()                       â”‚
â”‚      â”œâ”€â”€ Extract payment                    â”‚
â”‚      â”œâ”€â”€ Validate structure                 â”‚
â”‚      â”œâ”€â”€ Check amount                       â”‚
â”‚      â”œâ”€â”€ Verify signature                   â”‚
â”‚      â””â”€â”€ Return response                    â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Security Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Security Layers                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  Layer 1: Client Validation                       â”‚
â”‚  â”œâ”€â”€ Wallet connection                           â”‚
â”‚  â”œâ”€â”€ Network verification                        â”‚
â”‚  â””â”€â”€ Balance check                               â”‚
â”‚                                                    â”‚
â”‚  Layer 2: Signature Validation                    â”‚
â”‚  â”œâ”€â”€ EIP-712 typed data                          â”‚
â”‚  â”œâ”€â”€ User signs with private key                 â”‚
â”‚  â””â”€â”€ Browser never sees private key              â”‚
â”‚                                                    â”‚
â”‚  Layer 3: Server Validation                       â”‚
â”‚  â”œâ”€â”€ Payment structure check                     â”‚
â”‚  â”œâ”€â”€ Amount verification                         â”‚
â”‚  â”œâ”€â”€ Time window validation                      â”‚
â”‚  â””â”€â”€ Signature format check                      â”‚
â”‚                                                    â”‚
â”‚  Layer 4: Facilitator Verification                â”‚
â”‚  â”œâ”€â”€ Cryptographic signature verification        â”‚
â”‚  â”œâ”€â”€ Nonce uniqueness check                      â”‚
â”‚  â”œâ”€â”€ Payment authorization validity              â”‚
â”‚  â””â”€â”€ On-chain settlement                         â”‚
â”‚                                                    â”‚
â”‚  Layer 5: Blockchain Finality                     â”‚
â”‚  â”œâ”€â”€ USDC transfer executed                      â”‚
â”‚  â”œâ”€â”€ Transaction confirmed                       â”‚
â”‚  â””â”€â”€ Immutable record                            â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Data Flow

### 1. Payment Request
```
Client Request
    â†“
GET /api/authenticate
    â†“
No X-PAYMENT header detected
    â†“
Return 402 with PaymentDetails
    â†“
{
  maxAmountRequired: "0.10",
  payTo: "0xWalletAddress",
  asset: "0xUSDCAddress",
  network: "base-sepolia"
}
```

### 2. Payment Submission
```
User signs EIP-712 message
    â†“
Generate signature (v, r, s)
    â†“
Create PaymentPayload
    â†“
{
  from: "0xUserAddress",
  to: "0xSellerAddress",
  value: "100000",
  validAfter: timestamp,
  validBefore: timestamp + 3600,
  nonce: "0xrandom...",
  v: 27,
  r: "0x...",
  s: "0x..."
}
    â†“
POST /api/authenticate
X-PAYMENT: {PaymentPayload}
```

### 3. Verification
```
Server receives X-PAYMENT
    â†“
Extract and validate payload
    â†“
Send to facilitator
    â†“
Facilitator verifies signature
    â†“
Facilitator settles on blockchain
    â†“
Return verification result
    â†“
Server grants access
```

## ğŸ—„ï¸ State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Client State                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚
â”‚  paymentStatus                        â”‚
â”‚  â”œâ”€â”€ idle                            â”‚
â”‚  â”œâ”€â”€ connecting                      â”‚
â”‚  â”œâ”€â”€ signing                         â”‚
â”‚  â”œâ”€â”€ processing                      â”‚
â”‚  â”œâ”€â”€ success                         â”‚
â”‚  â””â”€â”€ error                           â”‚
â”‚                                       â”‚
â”‚  errorMessage: string | null         â”‚
â”‚  walletConnected: boolean            â”‚
â”‚  networkCorrect: boolean             â”‚
â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Server State                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                       â”‚
â”‚  No persistent state                 â”‚
â”‚  (Stateless by design)               â”‚
â”‚                                       â”‚
â”‚  Each request is independent         â”‚
â”‚  Payment verified per request        â”‚
â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”Œ Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      External Dependencies               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  MetaMask / Web3 Wallet                 â”‚
â”‚  â””â”€â”€ window.ethereum API                â”‚
â”‚                                          â”‚
â”‚  x402 Facilitator                       â”‚
â”‚  â””â”€â”€ https://x402.org/facilitator       â”‚
â”‚                                          â”‚
â”‚  Base Network                            â”‚
â”‚  â”œâ”€â”€ RPC Endpoint                       â”‚
â”‚  â””â”€â”€ USDC Smart Contract                â”‚
â”‚                                          â”‚
â”‚  Circle USDC Faucet                     â”‚
â”‚  â””â”€â”€ https://faucet.circle.com/         â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Performance Considerations

- **Frontend**: React components, client-side wallet interaction
- **Backend**: Stateless API routes, fast validation
- **Network**: HTTP requests, WebSocket support possible
- **Blockchain**: Facilitator handles on-chain settlement
- **Caching**: Can cache payment info, network configs

## ğŸ¨ Tech Stack

```
Frontend:
â”œâ”€â”€ Next.js 15 (App Router)
â”œâ”€â”€ React 19
â”œâ”€â”€ TypeScript
â”œâ”€â”€ Tailwind CSS
â””â”€â”€ Ethers.js

Backend:
â”œâ”€â”€ Next.js API Routes
â”œâ”€â”€ x402 Protocol
â””â”€â”€ TypeScript

Blockchain:
â”œâ”€â”€ Base Network
â”œâ”€â”€ USDC (ERC-20)
â”œâ”€â”€ ERC-3009 (Transfer with Authorization)
â””â”€â”€ EIP-712 (Typed Data Signing)

Tools:
â”œâ”€â”€ ESLint
â”œâ”€â”€ Prettier
â”œâ”€â”€ TypeScript Compiler
â””â”€â”€ npm
```

---

**This architecture enables fast, secure, and decentralized payments! ğŸš€**

